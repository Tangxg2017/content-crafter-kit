<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>创造你的启发时刻卡片</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/dompurify@3.0.6/dist/purify.min.js"></script>
  <!-- Add Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Import the new combined utility file as a module -->
  <script type="module" src="scripts/cardUtils.js"></script>
  <script type="module">
    import { initShareFunction } from './scripts/shareUtils.js';

    // 初始化分享功能
    document.addEventListener('DOMContentLoaded', function () {
      initShareFunction({
        cardSelector: '.card',
        shareButtonSelector: 'button[onclick="shareToWechat()"]',
        getShareData: function () {
          // 获取卡片信息
          const title = document.getElementById('title').value || '我的启发时刻卡片';
          const quote = document.getElementById('quote').value || '分享一个触动我的观点';
          const creator = document.getElementById('creator').value || '匿名';

          return {
            title: `${title} - by ${creator}`,
            desc: quote.length > 50 ? quote.substring(0, 50) + '...' : quote,
            link: window.location.href
          };
        }
      });
    });
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter&family=Playfair+Display&family=Montserrat&family=Lato&family=Dancing+Script&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC&family=Noto+Serif+SC&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">

  <style>
    * {
      -webkit-font-smoothing: antialiased;
      box-sizing: border-box;
    }

    body {
      display: flex;
      flex-direction: column;
      margin: 0;
      padding: 0;
      font-family: 'PingFang SC', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #f9f9f9, #e0eafc);
      min-height: 100vh;
      color: #333;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #FFB6C1, #FFE4E1, #F0E68C, #E0FFFF, #DDA0DD);
      color: #333;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      padding-top: 22px;
      text-align: left;
      margin-bottom: -8px;
    }

    .header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('images/mistyblue.png') center/cover no-repeat;
      opacity: 0.1;
      z-index: 0;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 15px;
      font-weight: bold;
      animation: fadeInDown 1s ease;
    }

    .header p {
      font-size: 18px;
      line-height: 1.6;
      margin: 0 auto;
      animation: fadeIn 1.5s ease;
    }

    /* Container */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
      gap: 40px;
      align-items: flex-start;
    }

    .main-content {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      padding: 30px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
      align-items: flex-start;
    }

    /* Form */
    .form {
      width: 600px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-self: flex-start;
      position: sticky;
      top: 0;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
    }

    .form label {
      font-weight: bold;
      color: #4a6fa5;
      font-size: 14px;
    }

    /* 重要字段的标签样式 */
    label[for="title"],
    label[for="quote"],
    label[for="detail"],
    label[for="creator"],
    label[for="title"] {
      font-size: 15px !important;
      font-weight: 700 !important;
      color: #2c3e50 !important;
      margin-bottom: 8px !important;
    }

    /* 添加必填标识 */
    label[for="title"]::after,
    label[for="quote"]::after,
    label[for="detail"]::after {
      content: " *";
      color: #e74c3c;
      font-weight: bold;
    }

    .form input,
    .form textarea,
    .form select {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      transition: all 0.3s ease;
    }

    /* 重要输入框样式 - 标题、观点、启发、作者 */
    #title,
    #quote,
    #detail,
    #creator {
      background-color: #fff;
      border: 1.5px solid #ddd;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      font-weight: 500;
      transition: all 0.3s ease;
    }

    #title {
      font-size: 16px;
      padding: 12px;
      /* border-color: #FFB6C1; */
      box-shadow: 0 1px 4px rgba(255, 182, 193, 0.1);
    }

    #quote,
    #detail {
      font-size: 15px;
      padding: 12px;
      line-height: 1.5;
      border-color: #B0C4DE;
      box-shadow: 0 1px 4px rgba(176, 196, 222, 0.1);
    }

    #creator {
      border-color: #B0C4DE;
      box-shadow: 0 1px 4px rgba(176, 196, 222, 0.1);
    }

    .form input:focus,
    .form textarea:focus,
    .form select:focus {
      border-color: #4a6fa5;
      box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
      background-color: #fff;
      outline: none;
    }

    #title:focus,
    #quote:focus,
    #detail:focus,
    #creator:focus {
      border-color: #4a6fa5 !important;
      box-shadow: 0 0 0 4px rgba(74, 111, 165, 0.3) !important;
    }

    /* Preview */
    #preview {
      width: 460px;
      display: flex;
      justify-content: center;
      /* Center card horizontally */
      align-items: flex-start;
      /* Center card vertically */
      padding: 24px;
      border-radius: 16px;
      background: transparent;
      transition: all 0.3s ease;
    }

    /* Card styles moved to card-common.css */

    /* Buttons */
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 20px;
      align-items: center;
    }

    button {
      padding: 12px 20px;
      /* background: linear-gradient(135deg, #FFE4E1, #F0E68C, #E0FFFF); */
      color: #666;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 182, 193, 0.3);
    }

    button:hover {
      background: linear-gradient(135deg, #FFD1DC, #F5DEB3, #B0E0E6);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 182, 193, 0.4);
    }

    .primary-btn {
      background: linear-gradient(135deg, #FF91A4, #FFB6C1, #FFE4B5, #98FB98) !important;
      color: #fff !important;
      /* font-size: 16px; */
      /* padding: 14px 24px; */
      font-weight: 700;
      box-shadow: 0 6px 20px rgba(255, 145, 164, 0.4);
      /* border: 2px solid rgba(255, 255, 255, 0.3); */
      position: relative;
      overflow: hidden;
    }

    .primary-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .primary-btn:hover::before {
      left: 100%;
    }

    .primary-btn:hover {
      background: linear-gradient(135deg, #FF69B4, #FF91A4, #FFD700, #90EE90) !important;
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 25px rgba(255, 105, 180, 0.5);
    }

    .upload-btn {
      background: linear-gradient(135deg, #F5F5F5, #E6E6FA, #F0F8FF);
      color: #666;
      border: 1px solid rgba(221, 160, 221, 0.3);
      box-shadow: 0 3px 8px rgba(221, 160, 221, 0.2);
      min-width: 140px;
      padding: 8px 16px;
    }

    .upload-btn:hover {
      background: linear-gradient(135deg, #E6E6FA, #D8BFD8, #E0E6FF);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(221, 160, 221, 0.3);
    }

    /* Carousel */
    .latest-cards-section {
      margin-top: 40px;
      width: 100%;
    }

    .carousel-container {
      width: 100%;
      max-width: 1200px;
      /* margin: 0 auto; */
      /* padding: 20px 0; */
    }

    .swiper {
      width: 100%;
      padding-bottom: 40px;
    }

    .swiper-slide {
      display: flex;
      justify-content: center;
      align-items: center;
      /* padding: 10px; */
    }

    .carousel-card-wrapper {
      width: 100%;
      max-width: 420px;
      /* min-width: 300px; */
      box-sizing: border-box;
    }

    .swiper-pagination {
      bottom: 0;
    }

    .swiper-button-next,
    .swiper-button-prev {
      color: #4a6fa5;
    }

    .view-all-button-container {
      text-align: center;
      margin-top: 20px;
    }

    .view-all-button {
      display: inline-block;
      background-color: #FF7F50;
      /* 橙色，和提交按钮统一 */
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      text-decoration: none;
      transition: transform 0.2s, background-color 0.2s;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .view-all-button:hover {
      background-color: #ff9966;
      /* hover时更亮一点 */
      transform: scale(1.05);
    }


    /* 统一按钮基础样式 */
    .header-btn {
      display: inline-block;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
      color: #666;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.5);
      cursor: pointer;
      backdrop-filter: blur(10px);
      text-align: center;
      white-space: nowrap;
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      color: #444;
    }

    /* View all button - 继承统一样式 */
    .view-all-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      margin: 0;
      z-index: 10;
    }

    /* Footer */
    .page-footer {
      text-align: center;
      padding: 20px;
      font-size: 14px;
      margin-top: auto;
      color: #666;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes shimmer {
      0% {
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      }

      100% {
        background-position: 20px 20px, 20px 30px, 30px 10px, 10px 20px;
      }
    }

    /* 认证相关样式 */
    .auth-section {
      position: absolute;
      top: 15px;
      right: 450px;
      z-index: 20;
    }

    .login-buttons {
      display: flex;
      gap: 10px;
    }

    .auth-btn {
      /* 移除原有样式，继承统一样式 */
    }

    /* 注册按钮特殊样式 */
    .auth-btn.register-btn {
      background: linear-gradient(135deg, #28a745, #20c997) !important;
      color: white !important;
      border: 1px solid rgba(40, 167, 69, 0.3) !important;
    }

    .auth-btn.register-btn:hover {
      background: linear-gradient(135deg, #218838, #1ea085) !important;
      color: white !important;
    }

    /* 特殊按钮样式 */
    .view-all-btn[style*="background-color: #e64a19"] {
      background: linear-gradient(135deg, #e64a19, #ff5722) !important;
      color: white !important;
      border: 1px solid rgba(230, 74, 25, 0.3) !important;
    }

    .view-all-btn[style*="background-color: #e64a19"]:hover {
      background: linear-gradient(135deg, #d84315, #e64a19) !important;
      color: white !important;
    }

    .user-profile {
      position: relative;
    }

    .user-avatar-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
    }

    .user-avatar-container:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      color: #666;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      padding: 8px 0;
      min-width: 140px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 100;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .user-avatar-container:hover .user-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      width: 100%;
      padding: 10px 16px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      transition: all 0.2s ease;
    }

    .dropdown-item:hover {
      background: rgba(102, 102, 102, 0.1);
      color: #444;
    }

    /* 背景选择器样式 */
    .gradient-selector {
      display: grid;
      grid-template-columns: repeat(14, 1fr);
      gap: 6px;
      margin-top: 6px;
    }

    .gradient-option {
      width: 38px;
      height: 38px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .gradient-option:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .gradient-option.selected {
      border-color: #4a6fa5;
      box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.3);
      transform: scale(1.05);
    }

    .gradient-option::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: inherit;
      opacity: 0.8;
    }

    /* 为每个渐变选项添加对应的背景 */
    .gradient-option[data-gradient="card-gradient-1"] {
      background-image: linear-gradient(to right top,
          rgba(209, 107, 165, 0.8), rgba(199, 119, 185, 0.7), rgba(186, 131, 202, 0.6),
          rgba(170, 143, 216, 0.5), rgba(154, 154, 225, 0.4), rgba(138, 167, 236, 0.3),
          rgba(121, 179, 244, 0.2), rgba(105, 191, 248, 0.3), rgba(82, 207, 254, 0.4),
          rgba(65, 223, 255, 0.5), rgba(70, 238, 250, 0.6), rgba(95, 251, 241, 0.7));
    }

    .gradient-option[data-gradient="card-gradient-2"] {
      background-image: linear-gradient(to right top,
          rgba(255, 126, 95, 0.8), rgba(255, 140, 109, 0.7), rgba(255, 154, 124, 0.6),
          rgba(255, 168, 138, 0.5), rgba(255, 182, 153, 0.4), rgba(255, 194, 168, 0.3),
          rgba(255, 206, 184, 0.2), rgba(255, 217, 199, 0.3), rgba(255, 229, 215, 0.4),
          rgba(255, 242, 231, 0.5), rgba(255, 254, 250, 0.6), rgba(255, 255, 255, 0.7));
    }

    .gradient-option[data-gradient="card-gradient-3"] {
      background-image: linear-gradient(to right top,
          rgba(107, 33, 168, 0.8), rgba(134, 47, 178, 0.7), rgba(160, 61, 189, 0.6),
          rgba(186, 76, 200, 0.5), rgba(211, 91, 211, 0.4), rgba(227, 108, 217, 0.3),
          rgba(242, 125, 223, 0.2), rgba(255, 141, 229, 0.3), rgba(255, 157, 226, 0.4),
          rgba(255, 172, 223, 0.5), rgba(255, 188, 221, 0.6), rgba(255, 204, 220, 0.7));
    }

    .gradient-option[data-gradient="card-gradient-4"] {
      background-image: linear-gradient(to right top,
          rgba(0, 201, 255, 0.8), rgba(0, 179, 255, 0.7), rgba(0, 156, 255, 0.6),
          rgba(0, 130, 255, 0.5), rgba(0, 100, 255, 0.4), rgba(0, 89, 255, 0.3),
          rgba(0, 77, 255, 0.2), rgba(0, 63, 255, 0.3), rgba(0, 49, 255, 0.4),
          rgba(0, 32, 255, 0.5), rgba(0, 12, 255, 0.6), rgba(11, 0, 255, 0.7));
    }

    .gradient-option[data-gradient="card-gradient-5"] {
      background-image: linear-gradient(to right top,
          rgba(249, 197, 44, 0.8), rgba(246, 182, 47, 0.7), rgba(242, 168, 51, 0.6),
          rgba(238, 153, 55, 0.5), rgba(233, 139, 60, 0.4), rgba(227, 126, 65, 0.3),
          rgba(221, 113, 70, 0.2), rgba(215, 100, 76, 0.3), rgba(207, 86, 79, 0.4),
          rgba(198, 73, 82, 0.5), rgba(188, 60, 84, 0.6), rgba(178, 48, 86, 0.7));
    }

    .gradient-option[data-gradient="card-gradient-6"] {
      background-image: linear-gradient(to right top,
          rgba(168, 255, 120, 0.8), rgba(159, 245, 120, 0.7), rgba(150, 235, 120, 0.6),
          rgba(141, 225, 120, 0.5), rgba(132, 215, 120, 0.4), rgba(124, 208, 120, 0.3),
          rgba(116, 201, 120, 0.2), rgba(108, 194, 120, 0.3), rgba(99, 186, 121, 0.4),
          rgba(90, 179, 121, 0.5), rgba(81, 172, 122, 0.6), rgba(72, 165, 122, 0.7));
    }

    .gradient-option[data-gradient="card-gradient-7"] {
      background-image: linear-gradient(to right top,
          rgba(255, 138, 0, 0.8), rgba(255, 122, 26, 0.7), rgba(255, 105, 42, 0.6),
          rgba(255, 86, 55, 0.5), rgba(255, 63, 67, 0.4), rgba(255, 54, 76, 0.3),
          rgba(255, 44, 85, 0.2), rgba(255, 33, 94, 0.3), rgba(255, 26, 106, 0.4),
          rgba(255, 23, 118, 0.5), rgba(255, 26, 131, 0.6), rgba(249, 37, 144, 0.7));
    }

    .gradient-option[data-gradient="card-gradient-8"] {
      background-image: linear-gradient(to right top,
          rgba(240, 248, 255, 0.8), rgba(230, 240, 250, 0.7), rgba(220, 235, 245, 0.6),
          rgba(210, 230, 240, 0.5), rgba(200, 225, 235, 0.4), rgba(190, 220, 230, 0.3),
          rgba(180, 215, 225, 0.2), rgba(170, 210, 220, 0.3));
    }

    .gradient-option[data-gradient="card-gradient-9"] {
      background-image: linear-gradient(to right top,
          rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.7), rgba(234, 240, 246, 0.6),
          rgba(226, 232, 240, 0.5), rgba(203, 213, 225, 0.4), rgba(186, 200, 214, 0.3),
          rgba(169, 187, 203, 0.2), rgba(148, 163, 184, 0.3));
    }

    .gradient-option[data-gradient="card-gradient-10"] {
      background-image: linear-gradient(to right top,
          rgba(254, 252, 232, 0.8), rgba(253, 246, 178, 0.7), rgba(252, 211, 77, 0.6),
          rgba(245, 158, 11, 0.5), rgba(217, 119, 6, 0.4), rgba(180, 83, 9, 0.3),
          rgba(146, 64, 14, 0.2), rgba(120, 53, 15, 0.3));
    }

    .gradient-option[data-gradient="card-gradient-11"] {
      background-image: linear-gradient(to right top,
          rgba(240, 253, 244, 0.8), rgba(220, 252, 231, 0.7), rgba(187, 247, 208, 0.6),
          rgba(134, 239, 172, 0.5), rgba(74, 222, 128, 0.4), rgba(34, 197, 94, 0.3),
          rgba(22, 163, 74, 0.2), rgba(21, 128, 61, 0.3));
    }

    .gradient-option[data-gradient="card-gradient-12"] {
      background-image: linear-gradient(to right top,
          rgba(253, 244, 255, 0.8), rgba(250, 232, 255, 0.7), rgba(243, 232, 255, 0.6),
          rgba(233, 213, 255, 0.5), rgba(196, 181, 253, 0.4), rgba(167, 139, 250, 0.3),
          rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.3));
    }

    .gradient-option[data-gradient="card-gradient-13"] {
      background-image: linear-gradient(to right top,
          rgba(255, 251, 235, 0.8), rgba(254, 243, 199, 0.7), rgba(253, 230, 138, 0.6),
          rgba(252, 211, 77, 0.5), rgba(245, 158, 11, 0.4), rgba(217, 119, 6, 0.3),
          rgba(194, 65, 12, 0.2), rgba(154, 52, 18, 0.3));
    }

    .gradient-option[data-gradient="card-gradient-14"] {
      background-image: linear-gradient(to right top,
          rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.7), rgba(226, 232, 240, 0.6),
          rgba(203, 213, 225, 0.5), rgba(148, 163, 184, 0.4), rgba(100, 116, 139, 0.3),
          rgba(71, 85, 105, 0.2), rgba(51, 65, 85, 0.3));
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
        padding: 20px;
      }

      .form,
      #preview {
        width: 100%;
      }

      .carousel-card-wrapper {
        max-width: 90%;
      }

      .auth-section {
        position: static;
        margin-bottom: 10px;
        right: auto;
        display: flex;
        justify-content: center;
      }

      .login-buttons {
        justify-content: center;
      }

      .user-avatar-container {
        justify-content: center;
      }

      .gradient-selector {
        grid-template-columns: repeat(7, 1fr);
      }

      .gradient-option {
        width: 35px;
        height: 35px;
      }
    }

    /* Markdown styles moved to card-common.css */
  </style>
  <link rel="stylesheet" href="/styles/card-common.css">
  <link rel="stylesheet" href="/styles/card-gradients.css">

</head>

<body>
  <!-- Header Section -->
  <header class="header">
    <div class="container">
      <h1>创造你的启发时刻卡片</h1>
      <p>💬 嘿，今天哪个瞬间戳中了你？✨ 快记下来！这些碎片会在未来发芽🌱</p>
      <p>▸ 书里某句让你猛划线的话？▸ 播客里那个让你突然按下暂停键的观点？▸ 电影里久久忘不掉的镜头？</p>
    </div>
    <div>
      <!-- 用户认证区域 -->
      <div id="auth-section" class="auth-section">
        <!-- 未登录状态 -->
        <div id="login-buttons" class="login-buttons">
          <a href="https://bysunling.com/auth?redirect=https://cards.bysunling.com" class="header-btn auth-btn">登录</a>
          <!-- <a href="https://bysunling.com/auth?tab=register&redirect=https://cards.bysunling.com" class="header-btn auth-btn register-btn">注册</a> -->
        </div>

        <!-- 已登录状态 -->
        <div id="user-profile" class="user-profile" style="display: none;">
          <div class="user-avatar-container">
            <img id="user-avatar" class="user-avatar" src="" alt="用户头像" crossorigin="anonymous">
            <span id="user-name" class="user-name"></span>
            <div class="user-dropdown">
              <button onclick="logout()" class="dropdown-item">退出登录</button>
            </div>
          </div>
        </div>
      </div>

      <a href="cover-editor.html" class="header-btn view-all-btn">制作封面</a>
      <a href="weekly-cards.html" class="header-btn view-all-btn" style="right: 115px;">查看每周会议卡片</a>
      <a href="cards.html" class="header-btn view-all-btn" style="right: 270px;">查看全部提交的卡片</a>
    </div>
  </header>


  <div class="container">
    <!-- Main Content -->
    <div class="main-content">
      <div class="form">
        <!-- 第一行：标题 -->
        <div class="form-row">
          <div class="form-group" style="flex: 0 0 120px;">
            <label for="creator">创作者</label>
            <input id="creator" placeholder="匿名" oninput="updateCardPreview()">
          </div>
          <div class="form-group" style="flex: 1;">
            <label for="title">标题</label>
            <input id="title" placeholder="这一刻，我想说..." oninput="updateCardPreview()">
          </div>
        </div>

        <!-- 第二行：触动你的观点 -->
        <div class="form-group">
          <label for="quote">触动你的观点<small style="color: #888; font-size: 9px;">按回车↩︎换行</small></label>
          <textarea id="quote" oninput="updateCardPreview()" placeholder="写下让你触动的一句话、一段对话、或一个片段..."></textarea>
        </div>

        <!-- 第三行：你的启发 -->
        <div class="form-group">
          <label for="detail">你的启发<small style="color: #888; font-size: 9px;">支持 Markdown 语法，按回车↩︎换行</small></label>
          <textarea id="detail" oninput="updateCardPreview()" style="min-height: 100px; resize: vertical;"
            placeholder="写下你的启发和行动吧..."></textarea>
          <div id="imageGenerationStatus" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
        </div>

        <!-- 第四行：选择背景 -->
        <div class="form-group">
          <label for="choose-gradient">选择背景</label>
          <div class="gradient-selector" id="gradient-selector">
            <div class="gradient-option selected" data-gradient="card-gradient-1" title="🌈 彩虹梦境"></div>
            <div class="gradient-option" data-gradient="card-gradient-2" title="🌅 日出暖阳"></div>
            <div class="gradient-option" data-gradient="card-gradient-3" title="💜 紫色幻想"></div>
            <div class="gradient-option" data-gradient="card-gradient-4" title="🌊 海洋蓝调"></div>
            <div class="gradient-option" data-gradient="card-gradient-5" title="🔥 火焰橙黄"></div>
            <div class="gradient-option" data-gradient="card-gradient-6" title="🌿 清新绿意"></div>
            <div class="gradient-option" data-gradient="card-gradient-7" title="❤️ 热情红橙"></div>
            <div class="gradient-option" data-gradient="card-gradient-8" title="☁️ 天空蓝白"></div>
            <div class="gradient-option" data-gradient="card-gradient-9" title="🌫️ 雾霭灰蓝"></div>
            <div class="gradient-option" data-gradient="card-gradient-10" title="🍯 蜂蜜暖黄"></div>
            <div class="gradient-option" data-gradient="card-gradient-11" title="🌱 薄荷清绿"></div>
            <div class="gradient-option" data-gradient="card-gradient-12" title="🌸 淡雅紫粉"></div>
            <div class="gradient-option" data-gradient="card-gradient-13" title="🌾 麦田金黄"></div>
            <div class="gradient-option" data-gradient="card-gradient-14" title="🌙 月光银灰"></div>
          </div>
        </div>

        <!-- 最后一行：自定义插图、找图按钮、选择字体 -->
        <div class="form-row" style="margin-bottom: -36px;">
          <div class="form-group">
            <label for="bgUpload">自定义插图</label>
            <div class="file-upload-wrapper">
              <button type="button" id="uploadBtn" class="upload-btn">📷 选择本地图片</button><br>
              <small id="fileStatus" style="color: #888; font-size: 7px; margin-left: 10px;"></small>
              <input type="file" id="bgUpload" accept="image/*" style="display: none;">
            </div>
          </div>
          <label for="bgUpload">或者</label>
          <div class="form-group">
            <label>&nbsp;</label>
            <button type="button" id="searchImagesBtn" class="upload-btn" style="min-width: 120px; padding: 8px 12px;">
              根据启发内容找图🔍
            </button>
          </div>
          <div class="form-group">
            <label for="choose-font">选择字体</label>
            <select id="choose-font" onchange="updateCardPreview()">
              <option value="'PingFang SC', sans-serif">苹方</option>
              <option value="'Noto Sans SC', sans-serif">思源黑体</option>
              <option value="'Smiley Sans', sans-serif">得意黑</option>
              <option value="'Ma Shan Zheng', cursive">马善政毛笔体</option>
              <option value="'LXGW WenKai', serif">霞鹜文楷</option>
              <option value="'Alibaba PuHuiTi', sans-serif">阿里汉仪智能黑体</option>
              <option value="'Noto Serif SC', serif">思源宋体</option>
              <option value="'KaiTi', serif">楷体</option>
            </select>
          </div>
        </div>

        <!-- 自动图片状态显示 - 隐藏或移到不明显位置 -->
        <div class="form-group" style="display: none;">
          <div id="autoImageStatus"
            style="font-size: 10px; color: #999; text-align: center; opacity: 0.7;">正在根据背景颜色自动匹配图片...
          </div>
        </div>

        <!-- 搜索图片状态和结果显示区 -->
        <!-- <div class="form-group"> -->
          <div id="searchImagesStatus" style="margin-top: -5px; font-size: 12px; color: #666;"></div>
          <!-- 搜索结果图片展示区 -->
          <div id="searchImagesResults" style="display: none; margin-top: -2px;">
            <h5 style="margin-bottom: 10px; font-size: 14px;">搜索结果：<span id="searchQuery"></span></h5>
            <div id="imageResults" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
          </div>
        <!-- </div> -->

        <div class="buttons">
          <button onclick="submitCard()" class="primary-btn">提交到展示区</button>
          <button onclick="downloadCardImage()">下载卡片</button>
          <!-- <button onclick="shareToWechat()" class="upload-btn">📱 分享到微信</button> -->
        </div>
      </div>

      <div id="preview" class="animate__animated animate__fadeIn">
        <!-- 卡片内容将在这里生成 -->
      </div>
    </div>

    <!-- Latest Submitted Cards Section -->
    <div class="latest-cards-section">
      <h2>展示区</h2>
      <div class="carousel-container">
        <div class="swiper" id="latest-cards-swiper">
          <div class="swiper-wrapper" id="latest-cards">
            <!-- Cards will be loaded here -->
          </div>
          <div class="swiper-pagination"></div>
          <div class="swiper-button-next"></div>
          <div class="swiper-button-prev"></div>
        </div>
      </div>
      <div class="view-all-button-container">
        <a href="cards.html" class="view-all-button">浏览更多灵感</a>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="page-footer">
    <p>启发星球 ✨ Inspiration Planet © 2025</p>
  </footer>

  <!-- Swiper JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

  <!-- Main script using ES modules -->
  <script type="module">
    // Import functions from cardUtils.js
    import {
      renderEditorCard,
      renderCarouselCard,
      downloadCard,
      uploadCard,
      fetchCards,
      onUploadBg,
      bindCustomFileUpload,
      getRandomItem,
      sanitizeAndValidateCard,
      processLongUrls
    } from './scripts/cardUtils.js';

    // Global variables
    window.customImage = "";
    window.currentGradientClass = "";
    window.selectedSearchImage = null;
    window.isLoadingAutoImage = false; // 跟踪自动图片加载状态

    // 图片缓存对象
    const imageCache = {};

    let swiper;

    // 渐变样式数组
    // 导入共享的渐变配置
    import { gradientClasses, gradientFontColors, getFontColorForGradient } from './scripts/gradientConfig.js';



    // 随机选择渐变背景
    function randomizeGradient() {
      const randomIndex = Math.floor(Math.random() * gradientClasses.length);
      window.currentGradientClass = gradientClasses[randomIndex];
      return window.currentGradientClass;
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function () {
      // 初始化随机渐变
      randomizeGradient();

      // 初始化渐变选择器
      initGradientSelector();

      // 根据初始背景颜色自动搜索图片
      autoSearchImagesByGradient(window.currentGradientClass);

      // 已移除内置图片选择功能
      // loadImages(() => {
      //   // Initial card render after images are loaded
      //   updateCardPreview();
      // });

      // Initial card render
      updateCardPreview();

      // Setup file upload
      setupFileUpload();

      // Load latest cards
      loadLatestCardsCarousel();

      // 自动聚焦到标题输入框
      setTimeout(() => {
        const titleInput = document.getElementById('title');
        if (titleInput) {
          titleInput.focus();
        }
      }, 500);

      // 检查URL参数中的登录信息（从主域名登录后的回调）
      checkLoginCallback();

      // 初始化认证UI
      updateAuthUI();

      // 监听storage变化（用于多标签页同步）
      window.addEventListener('storage', function (e) {
        if (e.key === 'authToken' || e.key === 'user') {
          updateAuthUI();
        }
      });
    });

    // 初始化渐变选择器
    function initGradientSelector() {
      const gradientOptions = document.querySelectorAll('.gradient-option');

      // 设置默认选中状态
      gradientOptions.forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.gradient === window.currentGradientClass) {
          option.classList.add('selected');
        }
      });

      // 添加点击事件监听器
      gradientOptions.forEach(option => {
        option.addEventListener('click', function () {
          // 移除所有选中状态
          gradientOptions.forEach(opt => opt.classList.remove('selected'));
          // 添加当前选中状态
          this.classList.add('selected');
          // 更新当前渐变类
          window.currentGradientClass = this.dataset.gradient;
          // 根据新选择的背景颜色自动搜索图片
          autoSearchImagesByGradient(window.currentGradientClass);
          // 更新卡片预览
          updateCardPreview();
        });
      });
    }

    // Function to handle gradient selection (保持向后兼容)
    window.updateGradientSelection = function () {
      // 这个函数现在主要用于向后兼容，实际功能由initGradientSelector处理
      updateCardPreview();
    };

    // Function to handle image selection - 已移除内置图片选择功能
    // window.onSelectImage = function () {
    //   customImage = "";
    //   // 清除搜索选中的图片
    //   window.selectedSearchImage = null;
    //   document.getElementById("fileStatus").innerHTML = "";
    //   updateCardPreview();
    // };

    // Function to submit a card
    window.submitCard = function () {
      // 确保使用当前选择的渐变背景（从选中的小方块获取）
      const selectedOption = document.querySelector('.gradient-option.selected');
      if (selectedOption) {
        window.currentGradientClass = selectedOption.dataset.gradient;
      }

      uploadCard({
        gradientClass: window.currentGradientClass,
        font: document.getElementById("choose-font").value,
        title: document.getElementById('title').value,
        quote: document.getElementById('quote').value,
        imagePath: '',
        detail: document.getElementById('detail').value,
        creator: document.getElementById('creator').value,
        upload: customImage,
        searchImageSelected: document.getElementById('quote-image-preview-card').src || '',
      }).then((result) => {
        if (result) {
          // Refresh latest cards carousel
          loadLatestCardsCarousel();
        }
      });
    };

    window.updateCardPreview = function (uploadImg) {
      // If uploadImg is provided, update the customImage variable
      if (uploadImg) {
        customImage = uploadImg;
      }

      // 获取详情内容并转换Markdown为HTML
      const detailText = document.getElementById('detail').value || '请填写你的启发和行动';

      // 配置marked，启用换行选项
      marked.setOptions({
        breaks: true  // 将单个换行符解析为<br>
      });

      // 使用marked.js解析Markdown
      const parsedDetail = detailText ? marked.parse(detailText) : '';

      const options = {
        title: document.getElementById('title').value || '这一刻，我想说...',
        quote: document.getElementById('quote').value || '请写下触动到你的观点',
        detail: parsedDetail, // 使用解析后的HTML
        imagePath: '',
        creator: document.getElementById('creator').value || '匿名',
        font: document.getElementById('choose-font').value || `'Noto Sans SC', sans-serif`,
        gradientClass: window.currentGradientClass,
        customImage: customImage,
        created: new Date().toISOString(), // 添加当前时间
        isMarkdown: true // 标记使用了Markdown
      };

      // 优先级：搜索选中的图片 > 自定义上传的图片 > 加载状态显示
      // 检查是否有真正选择的搜索结果图片（通过特定的标识来判断）
      const searchSelectedImage = window.selectedSearchImage || '';
      let finalImage = searchSelectedImage || customImage;

      // 如果正在加载自动图片且没有选中的图片，显示加载状态而不是内置图片
      if (window.isLoadingAutoImage && !finalImage) {
        finalImage = null; // 不显示任何图片，稍后会添加加载提示
      } else if (!finalImage) {
        finalImage = ''; // 没有内置图片选择功能
      }
      // 格式化当前时间
      const now = new Date();
      const pad = (n) => n.toString().padStart(2, '0');
      const currentTime = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

      // 获取当前渐变对应的字体颜色
      const fontColor = getFontColorForGradient(window.currentGradientClass);
      const quoteBoxBg = 'rgba(255, 255, 255, 0.9)';
      const cardHTML = `
        <div class="card ${window.currentGradientClass}" style="
              font-family: ${options.font};
              color: ${fontColor};
            ">
           <div class="card-body">
            <div class="title">${options.title}</div>
            <div class="quote-box" style="
              background-color: ${quoteBoxBg}; 
              color: ${fontColor};
            ">${options.quote}</div>
            ${finalImage ? `<img id="quote-image-preview-card" src="${finalImage}" alt="Card Image" crossorigin="anonymous" />` : (window.isLoadingAutoImage ? `<div class="image-loading-placeholder" style="
              width: 100%;
              height: 200px;
              background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
              background-size: 20px 20px;
              background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
              border-radius: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #666;
              font-size: 14px;
              animation: shimmer 2s infinite;
            ">正在为您匹配图片...</div>` : '')}
            <div class="detail-text">${processLongUrls(options.detail)}</div>
          </div>
          <div class="card-footer">
            <div class="footer" style="color: ${fontColor}">——作者：${options.creator} · ${currentTime}</div>
          </div>
        </div>
      `;

      // Clear the preview container and append the new card
      const previewContainer = document.getElementById('preview');
      previewContainer.innerHTML = cardHTML;
    };

    // Function to download the current card
    window.downloadCardImage = function () {
      downloadCard(".card", "inspiration-card-");
    };

    // Setup file upload functionality
    function setupFileUpload() {
      const bgUpload = document.getElementById('bgUpload');
      const uploadBtn = document.getElementById('uploadBtn');
      const fileStatus = document.getElementById('fileStatus');

      if (!bgUpload || !uploadBtn || !fileStatus) {
        console.warn("上传功能初始化失败：元素未找到");
        return;
      }

      // 直接绑定上传按钮点击事件
      uploadBtn.addEventListener('click', () => {
        bgUpload.click();
      });

      // 绑定文件选择事件
      bgUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          customImage = e.target.result;
          // 清除搜索选中的图片，避免冲突
          window.selectedSearchImage = null;
          fileStatus.textContent = '已上传：' + file.name;
          updateCardPreview(customImage); // 确保传递图片数据
          event.target.value = ''; // 清空值以支持重复上传
        };
        reader.readAsDataURL(file);
      });

    }

    // Load and render latest cards to carousel
    async function loadLatestCardsCarousel() {
      const container = document.getElementById('latest-cards');
      if (!container) return;

      // Show loading indicator
      container.innerHTML = '<div class="swiper-slide"><div class="loading-indicator">加载中...</div></div>';

      try {
        const cards = await fetchCards();

        if (!cards || cards.length === 0) {
          container.innerHTML = '<div class="swiper-slide"><div class="loading-indicator">暂无卡片数据</div></div>';
          return;
        }

        // Clear loading indicator
        container.innerHTML = '';

        // Filter valid cards and limit to 20
        const validCards = cards.filter(card => card && card.Title && card.Quote).map(card => sanitizeAndValidateCard(card, ['Font', 'Title', 'Quote', 'Detail', 'ImagePath', 'Creator']))
          .filter(result => result.isValid)
          .map(result => result.sanitizedCard);
        const recentCards = validCards.slice(0, 20);

        // Render each card
        recentCards.forEach((card, index) => {
          const cardElement = renderCarouselCard(card, index);
          cardElement.style.cursor = 'pointer';
          cardElement.addEventListener('click', () => {
            window.location.href = `card-detail.html?id=${card.id}`;
          });
          container.appendChild(cardElement);
        });

        // Initialize or update Swiper
        initOrUpdateSwiper();
      } catch (error) {
        console.error('加载最新卡片失败:', error);
        container.innerHTML = '<div class="swiper-slide"><div class="loading-indicator">加载失败，请稍后再试</div></div>';
      }
    }

    // Initialize or update Swiper
    function initOrUpdateSwiper() {
      if (swiper) {
        swiper.update();
      } else {
        swiper = new Swiper('#latest-cards-swiper', {
          slidesPerView: 1,
          spaceBetween: 30,
          loop: true,
          centeredSlides: true,
          autoplay: {
            delay: 5 * 60 * 1000,
            disableOnInteraction: true,
          },
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
          breakpoints: {
            640: {
              slidesPerView: 1,
            },
            768: {
              slidesPerView: 2,
            },
            1024: {
              slidesPerView: 3,
            },
          }
        });
      }
    }
    // 根据渐变背景颜色自动搜索图片
    async function autoSearchImagesByGradient(gradientClass) {
      const statusDiv = document.getElementById('autoImageStatus');
      const resultsDiv = document.getElementById('autoImageResults');
      const imageGridDiv = document.getElementById('autoImageGrid');
      
      // 如果显示元素不存在，仍然执行搜索但不显示界面

      // 定义渐变对应的搜索关键词
      const gradientSearchTerms = {
        'card-gradient-1': 'rainbow colorful abstract art',
        'card-gradient-2': 'sunrise warm orange yellow nature',
        'card-gradient-3': 'purple fantasy magical violet',
        'card-gradient-4': 'ocean blue water sea waves',
        'card-gradient-5': 'fire flame orange red energy',
        'card-gradient-6': 'green nature forest fresh leaves',
        'card-gradient-7': 'red orange passion warm sunset',
        'card-gradient-8': 'sky blue white clouds peaceful',
        'card-gradient-9': 'grey mist fog minimal calm',
        'card-gradient-10': 'honey yellow warm golden light',
        'card-gradient-11': 'mint green fresh nature spring',
        'card-gradient-12': 'purple pink soft pastel flowers',
        'card-gradient-13': 'golden wheat field warm autumn',
        'card-gradient-14': 'silver grey moonlight minimal'
      };

      const searchTerm = gradientSearchTerms[gradientClass] || 'abstract colorful';

      try {
        // 检查缓存
        if (imageCache[gradientClass] && imageCache[gradientClass].length > 0) {
          // 从缓存中随机选择一张图片
          const cachedImages = imageCache[gradientClass];
          const randomIndex = Math.floor(Math.random() * cachedImages.length);
          const selectedImage = cachedImages[randomIndex];

          // 设置选中的图片
          window.selectedSearchImage = selectedImage.url;
          window.customImage = null;
          window.isLoadingAutoImage = false;

          // 显示缓存的图片
          displayImages(cachedImages, randomIndex, statusDiv, resultsDiv, imageGridDiv);

          // 更新状态
          statusDiv.textContent = '已从缓存加载图片';

          // 更新卡片预览
          updateCardPreview();
          return;
        }

        // 设置加载状态
        window.isLoadingAutoImage = true;
        window.selectedSearchImage = null;
        window.customImage = null;

        // 更新状态显示和卡片预览
        if (statusDiv) statusDiv.textContent = '正在根据背景颜色自动匹配图片...';
        if (resultsDiv) resultsDiv.style.display = 'none';
        updateCardPreview(); // 立即更新预览显示加载状态

        // 调用搜索API
        const response = await fetch('/.netlify/functions/searchImage', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: searchTerm,
            orientation: 'landscape'
          }),
        });

        const data = await response.json();

        if (response.ok && data.images && data.images.length > 0) {
          // 缓存图片数据
          imageCache[gradientClass] = data.images;

          // 清除加载状态并随机选择一张图片
          window.isLoadingAutoImage = false;
          const randomIndex = Math.floor(Math.random() * data.images.length);
          const selectedImage = data.images[randomIndex];
          window.selectedSearchImage = selectedImage.url;
          window.customImage = null; // 清除自定义上传的图片

          // 显示所有图片供用户选择（如果显示元素存在）
          if (statusDiv && resultsDiv && imageGridDiv) {
            displayImages(data.images, randomIndex, statusDiv, resultsDiv, imageGridDiv);
          }

          // 更新状态
          if (statusDiv) statusDiv.textContent = '';

          // 更新卡片预览
          updateCardPreview();
        } else {
          // 清除加载状态
          window.isLoadingAutoImage = false;
          if (statusDiv) statusDiv.textContent = '未找到匹配的图片';
          window.selectedSearchImage = null;
          window.customImage = null;
          updateCardPreview();
        }
      } catch (error) {
        // 清除加载状态
        window.isLoadingAutoImage = false;
        console.error('自动搜索图片失败:', error);
        if (statusDiv) statusDiv.textContent = '自动搜索图片失败，请稍后再试';
        window.selectedSearchImage = null;
        window.customImage = null;
        updateCardPreview();
      }
    }

    // 显示图片的辅助函数
    function displayImages(images, selectedIndex, statusDiv, resultsDiv, imageGridDiv) {
      // 清空之前的结果
      imageGridDiv.innerHTML = '';

      images.forEach((image, index) => {
        const imgContainer = document.createElement('div');
        imgContainer.style.width = 'calc(33.33% - 10px)';
        imgContainer.style.position = 'relative';
        imgContainer.style.cursor = 'pointer';
        imgContainer.style.borderRadius = '8px';
        imgContainer.style.overflow = 'hidden';
        imgContainer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';

        // 选中的图片高亮显示
        if (index === selectedIndex) {
          imgContainer.style.border = '3px solid #4a6fa5';
        }

        const img = document.createElement('img');
        img.src = image.thumb;
        img.alt = image.title;
        img.style.width = '100%';
        img.style.height = '100px';
        img.style.objectFit = 'cover';

        const overlay = document.createElement('div');
        overlay.style.position = 'absolute';
        overlay.style.bottom = '0';
        overlay.style.left = '0';
        overlay.style.right = '0';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.6)';
        overlay.style.color = 'white';
        overlay.style.padding = '4px';
        overlay.style.fontSize = '10px';
        overlay.textContent = image.description;

        imgContainer.appendChild(img);
        imgContainer.appendChild(overlay);

        // 添加点击事件
        imgContainer.addEventListener('click', () => {
          window.selectedSearchImage = image.url;
          window.customImage = null;

          // 更新选中状态
          document.querySelectorAll('#autoImageGrid > div').forEach(div => {
            div.style.border = 'none';
          });
          imgContainer.style.border = '3px solid #4a6fa5';

          // 更新卡片预览
          updateCardPreview();
        });

        imageGridDiv.appendChild(imgContainer);
      });

      // 显示结果
      resultsDiv.style.display = 'block';
    }

    // Function to search for images based on inspiration content
    async function searchImagesFromDetail() {
      // Get content from all three fields
      const titleText = document.getElementById('title').value || '';
      const quoteText = document.getElementById('quote').value || '';
      const detailText = document.getElementById('detail').value || '';

      // Check if at least one field has content
      if (!titleText && !quoteText && !detailText) {
        alert('请先输入标题、引用或启发内容');
        return;
      }

      const searchBtn = document.getElementById('searchImagesBtn');
      const statusDiv = document.getElementById('searchImagesStatus');
      const resultsDiv = document.getElementById('searchImagesResults');
      const querySpan = document.getElementById('searchQuery');
      const imageResultsDiv = document.getElementById('imageResults');

      try {
        // Update UI to show loading state
        searchBtn.disabled = true;
        statusDiv.textContent = '正在搜索相关图片，请稍候...';
        resultsDiv.style.display = 'none';

        // Combine all three fields for searching
        const combinedText = [titleText, quoteText, detailText].filter(text => text.trim()).join(' ');

        // Call the Netlify function
        const response = await fetch('/.netlify/functions/searchImage', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: combinedText,
            orientation: 'landscape'
          }),
        });

        const data = await response.json();

        if (response.ok) {
          // Display the search query
          querySpan.textContent = data.query;

          // Clear previous results
          imageResultsDiv.innerHTML = '';

          // Display the images
          if (data.images && data.images.length > 0) {
            data.images.forEach(image => {
              const imgContainer = document.createElement('div');
              imgContainer.style.width = 'calc(33.33% - 10px)';
              imgContainer.style.position = 'relative';
              imgContainer.style.cursor = 'pointer';
              imgContainer.style.borderRadius = '8px';
              imgContainer.style.overflow = 'hidden';
              imgContainer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';

              const img = document.createElement('img');
              img.src = image.thumb;
              img.alt = image.title;
              img.style.width = '100%';
              img.style.height = '100px';
              img.style.objectFit = 'cover';

              const overlay = document.createElement('div');
              overlay.style.position = 'absolute';
              overlay.style.bottom = '0';
              overlay.style.left = '0';
              overlay.style.right = '0';
              overlay.style.backgroundColor = 'rgba(0,0,0,0.6)';
              overlay.style.color = 'white';
              overlay.style.padding = '4px';
              overlay.style.fontSize = '10px';
              overlay.textContent = image.description;

              imgContainer.appendChild(img);
              imgContainer.appendChild(overlay);

              // Add click event to select this image
              imgContainer.addEventListener('click', () => {
                // 设置选中的搜索图片
                window.selectedSearchImage = image.url;
                // 清除自定义上传的图片，避免冲突
                customImage = null;
                // 更新文件状态显示
                const fileStatus = document.getElementById('fileStatus');
                if (fileStatus) {
                  fileStatus.textContent = '已选择搜索结果图片';
                }
                // Update the card preview
                updateCardPreview();
                // Add a highlight to the selected image
                document.querySelectorAll('#imageResults > div').forEach(div => {
                  div.style.border = 'none';
                });
                imgContainer.style.border = '3px solid #4a6fa5';
              });

              imageResultsDiv.appendChild(imgContainer);
            });

            // Show the results
            resultsDiv.style.display = 'block';
            statusDiv.textContent = ''; // Clear status message
          } else {
            statusDiv.textContent = '未找到相关图片，请尝试修改启发内容。';
          }
        } else {
          throw new Error(data.error || '搜索图片失败');
        }
      } catch (error) {
        console.error('Error searching images:', error);
        statusDiv.textContent = `搜索失败: ${error.message}`;
      } finally {
        searchBtn.disabled = false;
      }
    }

    // Add event listener for the search images button
    document.getElementById('searchImagesBtn').addEventListener('click', searchImagesFromDetail);

    // 检查登录回调
    function checkLoginCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      const userInfo = urlParams.get('user');
      
      if (token && userInfo) {
        try {
          // 解码用户信息
          const user = JSON.parse(decodeURIComponent(userInfo));
          
          // 保存到本地存储
          localStorage.setItem('authToken', token);
          localStorage.setItem('user', JSON.stringify(user));
          
          // 清除URL参数
          const newUrl = window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
          
          // 更新UI
          updateAuthUI();
          
          console.log('登录成功，欢迎回来！');
        } catch (error) {
          console.error('处理登录回调失败:', error);
        }
      }
    }

    // Authentication functions
    async function checkAuthStatus() {
      // 首先检查本地存储
      const token = localStorage.getItem('authToken');
      const user = localStorage.getItem('user');

      if (token && user) {
        try {
          return JSON.parse(user);
        } catch (e) {
          console.error('解析用户信息失败:', e);
        }
      }

      // 如果本地没有登录信息，尝试从主域名检查登录状态
      try {
        const response = await fetch('https://bysunling.com/api/auth/status', {
          method: 'GET',
          credentials: 'include', // 包含cookies
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.user && data.token) {
            // 同步登录状态到本地
            localStorage.setItem('authToken', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            return data.user;
          }
        }
      } catch (error) {
        console.log('无法从主域名获取登录状态:', error.message);
      }

      return null;
    }

    window.logout = async function () {
      // 清除本地登录状态
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      
      // 尝试从主域名登出
      try {
        await fetch('https://bysunling.com/api/auth/logout', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });
      } catch (error) {
        console.log('主域名登出失败:', error.message);
      }
      
      updateAuthUI();
      // 可选：刷新页面或重定向
      window.location.reload();
    };

    async function updateAuthUI() {
      const user = await checkAuthStatus();
      const loginButtons = document.getElementById('login-buttons');
      const userProfile = document.getElementById('user-profile');

      if (user) {
        // 已登录状态
        if (loginButtons) loginButtons.style.display = 'none';
        if (userProfile) userProfile.style.display = 'block';

        // 更新用户信息
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');

        if (userAvatar && userName) {
          // 设置头像（如果用户有头像URL，否则使用默认头像）
          if (user.avatar_url) {
            userAvatar.src = user.avatar_url;
          } else {
            // 使用用户名首字母生成头像
            userAvatar.src = generateAvatarUrl(user.email || user.username || '用户');
          }

          // 设置用户名
          userName.textContent = user.username || user.email || '用户';
        }

        // 自动填充创作者字段
        const creatorInput = document.getElementById('creator');
        if (creatorInput && !creatorInput.value) {
          creatorInput.value = user.name || user.username || user.email || '';
          // 更新卡片预览
          updateCardPreview();
        }
      } else {
        // 未登录状态
        if (loginButtons) {
          loginButtons.style.display = 'flex';
        }
        if (userProfile) userProfile.style.display = 'none';
      }
    }

    // 生成默认头像URL（使用用户名首字母）
    function generateAvatarUrl(name) {
      const firstChar = name.charAt(0).toUpperCase();
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
      const colorIndex = name.charCodeAt(0) % colors.length;
      const bgColor = colors[colorIndex];

      // 创建本地SVG头像以避免CORS问题
      const svg = `
        <svg width="64" height="64" xmlns="http://www.w3.org/2000/svg">
          <rect width="64" height="64" fill="${bgColor}"/>
          <text x="32" y="40" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="white">${firstChar}</text>
        </svg>
      `;

      // 将SVG转换为data URL
      const svgBlob = new Blob([svg], { type: 'image/svg+xml' });
      return URL.createObjectURL(svgBlob);
    }

    // 分享功能已移至 shareUtils.js 模块
  </script>
</body>

</html>